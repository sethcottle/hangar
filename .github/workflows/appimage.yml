# SPDX-License-Identifier: MPL-2.0

name: AppImage

on:
  workflow_dispatch:

jobs:
  appimage:
    name: Build AppImage
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            libadwaita-1-dev \
            libsecret-1-dev \
            librsvg2-dev \
            libfuse2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release

      - name: Download appimagetool
        run: |
          curl -sSL https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -o appimagetool
          chmod +x appimagetool

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
          mkdir -p AppDir/usr/share/metainfo

          cp target/release/hangar AppDir/usr/bin/
          cp data/io.github.sethcottle.Hangar.desktop AppDir/usr/share/applications/
          cp assets/icons/io.github.sethcottle.Hangar.svg AppDir/usr/share/icons/hicolor/scalable/apps/
          cp data/io.github.sethcottle.Hangar.metainfo.xml AppDir/usr/share/metainfo/

          # Desktop file and icon symlinks at AppDir root (required by AppImage spec)
          ln -s usr/share/applications/io.github.sethcottle.Hangar.desktop AppDir/io.github.sethcottle.Hangar.desktop
          ln -s usr/share/icons/hicolor/scalable/apps/io.github.sethcottle.Hangar.svg AppDir/io.github.sethcottle.Hangar.svg
          # .DirIcon is used as the AppImage icon
          ln -s usr/share/icons/hicolor/scalable/apps/io.github.sethcottle.Hangar.svg AppDir/.DirIcon

      - name: Create AppRun script
        run: |
          printf '%s\n' '#!/bin/bash' > AppDir/AppRun
          printf '%s\n' '# AppRun for Hangar â€” GTK4 + libadwaita app' >> AppDir/AppRun
          printf '%s\n' '#' >> AppDir/AppRun
          printf '%s\n' '# Hangar does NOT bundle GTK4/libadwaita libraries. It uses the' >> AppDir/AppRun
          printf '%s\n' '# host system libraries, which are available on all supported' >> AppDir/AppRun
          printf '%s\n' '# Linux desktops (GNOME 43+, Fedora 39+, Ubuntu 23.10+, etc).' >> AppDir/AppRun
          printf '%s\n' '#' >> AppDir/AppRun
          printf '%s\n' '# This is intentional: bundling GTK4/libadwaita from the build' >> AppDir/AppRun
          printf '%s\n' '# environment (Ubuntu 24.04) causes theme/rendering failures on' >> AppDir/AppRun
          printf '%s\n' '# newer distros due to library version mismatches.' >> AppDir/AppRun
          printf '%s\n' '' >> AppDir/AppRun
          printf '%s\n' 'HERE="$(dirname "$(readlink -f "$0")")"' >> AppDir/AppRun
          printf '%s\n' '' >> AppDir/AppRun
          printf '%s\n' '# Make system data dirs available for icon and GSettings schema lookup,' >> AppDir/AppRun
          printf '%s\n' '# while also including our own data dir for the app icon and metainfo.' >> AppDir/AppRun
          printf '%s\n' 'export XDG_DATA_DIRS="${HERE}/usr/share:/usr/share:/usr/local/share:${XDG_DATA_DIRS:-/usr/share}"' >> AppDir/AppRun
          printf '%s\n' '' >> AppDir/AppRun
          printf '%s\n' 'exec "${HERE}/usr/bin/hangar" "$@"' >> AppDir/AppRun
          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          # Build the AppImage using appimagetool directly.
          # No linuxdeploy = no automatic library bundling.
          # Hangar relies on the host system's GTK4 + libadwaita.
          #
          # --appimage-extract-and-run: required in CI (no FUSE available)
          # -u: update information for delta updates via zsync
          ARCH=x86_64 ./appimagetool --appimage-extract-and-run \
            -u "gh-releases-zsync|sethcottle|hangar|latest|Hangar*.AppImage.zsync" \
            AppDir

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: hangar-appimage
          path: |
            Hangar*.AppImage
            Hangar*.AppImage.zsync
          retention-days: 7
